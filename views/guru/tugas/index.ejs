<%- include('../../partials/header', { title: 'Kelola Tugas' }) %>
<%- include('../../components/sidebar-guru', { activePage: 'tugas', profil: profil }) %>

<div class="main-content">

    <%- include('../../components/navbar', { title: 'Kelola Tugas', user: profil }) %>

    <div class="card card-custom bg-primary text-white border-0 mb-4">
        <div class="card-body p-4 d-flex justify-content-between align-items-center">
            <div>
                <h5 class="fw-bold mb-1"><%= mengajar.nama_mapel %></h5>
                <p class="mb-0 opacity-75">Kelas <%= mengajar.nama_kelas %></p>
            </div>
            <div>
                <button class="btn btn-light text-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalBuatTugas">
                    <i class="fas fa-plus me-2"></i> Buat Tugas Baru
                </button>
            </div>
        </div>
    </div>

    <% if (tugasList.length === 0) { %>
        <div class="text-center py-5">
            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="120" class="mb-3 opacity-50">
            <h6 class="text-muted">Belum ada tugas yang diberikan.</h6>
        </div>
    <% } else { %>
        <div class="row g-4">
            <% tugasList.forEach(tugas => { %>
            <div class="col-md-6">
                <div class="card card-custom h-100 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <% 
                                let badgeColor = 'bg-secondary';
                                if(tugas.tipe_tugas === 'PR') badgeColor = 'bg-info';
                                if(tugas.tipe_tugas === 'UTS') badgeColor = 'bg-warning text-dark';
                                if(tugas.tipe_tugas === 'UAS') badgeColor = 'bg-danger';
                                if(tugas.tipe_tugas === 'Tugas Harian') badgeColor = 'bg-success';
                            %>
                            <span class="badge <%= badgeColor %> rounded-pill px-3"><%= tugas.tipe_tugas %></span>
                            <small class="text-muted"><i class="far fa-clock me-1"></i> Deadline: <%= tugas.deadline_fmt %></small>
                        </div>

                        <h5 class="fw-bold text-dark mb-2"><%= tugas.judul %></h5>
                        <p class="text-muted small mb-3 text-truncate"><%= tugas.deskripsi %></p>

                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <span class="small fw-bold text-primary">
                                <i class="fas fa-users me-1"></i> <%= tugas.total_kumpul %> Siswa Mengumpulkan
                            </span>
                            
                            <div class="btn-group">
                                <a href="/guru/tugas/edit/<%= tugas.id %>" class="btn btn-sm btn-outline-warning" title="Edit">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <a href="/guru/tugas/hapus/<%= tugas.id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Yakin hapus?')" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </a>
                                <a href="/guru/tugas/lihat/<%= tugas.id %>" class="btn btn-sm btn-outline-primary">
                                    Lihat <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% }) %>
        </div>
    <% } %>

</div>

<div class="modal fade" id="modalBuatTugas" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        
        <form id="formTugas" class="modal-content" action="/guru/tugas/<%= mengajar.id %>" method="POST" enctype="multipart/form-data">
            
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">üìù Buat Tugas Baru</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold small">Judul Tugas</label>
                        <input type="text" name="judul" class="form-control" placeholder="Contoh: Kuis Harian Bab 1" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small">Tipe Tugas</label>
                        <select name="tipe_tugas" class="form-select" required>
                            <option value="Tugas Harian">Tugas Harian</option>
                            <option value="PR">PR</option>
                            <option value="UTS">UTS</option>
                            <option value="UAS">UAS</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">Deskripsi / Instruksi</label>
                    <textarea name="deskripsi" class="form-control" rows="2" placeholder="Kerjakan dengan teliti..."></textarea>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small">Deadline</label>
                        <input type="datetime-local" name="deadline" class="form-control" required>
                    </div>
                </div>

                <hr>

                <label class="form-label fw-bold mb-3">Metode Pemberian Soal:</label>
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active btn-sm border" id="pills-file-tab" data-bs-toggle="pill" data-bs-target="#pills-file" type="button">
                            <i class="fas fa-file-upload me-2"></i> Upload File
                        </button>
                    </li>
                    <li class="nav-item ms-2">
                        <button class="nav-link btn-sm border" id="pills-manual-tab" data-bs-toggle="pill" data-bs-target="#pills-manual" type="button">
                            <i class="fas fa-list-ol me-2"></i> Input Soal Manual
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="pills-file">
                        <div class="alert alert-light border">
                            <label class="form-label fw-bold small">File Soal (PDF/Gambar)</label>
                            <input type="file" name="file_tugas" class="form-control">
                            <small class="text-muted">Guru mengupload file soal, siswa menjawab dengan file juga.</small>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-manual">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">Buat soal Essay atau Pilihan Ganda.</small>
                            <button type="button" class="btn btn-sm btn-success rounded-pill px-3" onclick="tambahSoal()">
                                <i class="fas fa-plus me-1"></i> Tambah Soal
                            </button>
                        </div>

                        <div id="container-soal"></div>
                    </div>

                </div>

            </div> <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary fw-bold">Bagikan Tugas</button>
            </div>

        </form>
    </div>
</div>

<script>
    // --- SCRIPT DINAMIS V3.0 (Validasi & Dynamic Options) ---

    // 1. VALIDASI SEBELUM SUBMIT (Agar Kunci PG tidak kosong)
    document.getElementById('formTugas').addEventListener('submit', function(e) {
        const jenisSoal = document.getElementsByName('jenis_soal[]');
        const kunciPG = document.getElementsByName('kunci_pg[]'); 
        
        for (let i = 0; i < jenisSoal.length; i++) {
            if (jenisSoal[i].value === 'pg') {
                if (kunciPG[i].value === "") {
                    e.preventDefault(); 
                    alert(`‚ö†Ô∏è PERINGATAN!\n\nSoal No. ${i + 1} (Pilihan Ganda) belum ada Kunci Jawabannya.\nMohon pilih jawaban yang benar dulu.`);
                    kunciPG[i].focus();
                    kunciPG[i].classList.add('border', 'border-danger');
                    return; 
                } else {
                    kunciPG[i].classList.remove('border', 'border-danger');
                }
            }
        }
    });

    // 2. Trigger Otomatis Tab Manual
    const tabManual = document.getElementById('pills-manual-tab');
    tabManual.addEventListener('shown.bs.tab', function (event) {
        const container = document.getElementById('container-soal');
        if (container.children.length === 0) {
            tambahSoal();
        }
    });

    // 3. Fungsi Tambah Kartu Soal
    function tambahSoal() {
        const container = document.getElementById('container-soal');
        const nomor = container.children.length + 1;
        const uniqueId = Date.now() + Math.floor(Math.random() * 1000); 
        
        const html = `
            <div class="card card-body bg-light border-0 mb-3 soal-item position-relative shadow-sm" id="soal-${uniqueId}">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-2" onclick="this.parentElement.remove()"></button>
                
                <input type="hidden" name="soal_id[]" value="${uniqueId}">

                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-primary me-2">Soal No. ${nomor}</span>
                    <select name="jenis_soal[]" class="form-select form-select-sm w-auto" onchange="toggleOpsi(this)">
                        <option value="essay">Essay / Isian</option>
                        <option value="pg">Pilihan Ganda</option>
                    </select>
                </div>

                <div class="mb-2">
                    <textarea name="soal_teks[]" class="form-control" rows="2" placeholder="Tulis pertanyaan..." required></textarea>
                </div>

                <div class="area-opsi d-none ps-3 border-start border-3 border-primary mb-2">
                    <label class="small text-muted mb-1">Opsi Jawaban:</label>
                    <div class="list-opsi-container mb-2"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="tambahOpsi('${uniqueId}')">
                        <i class="fas fa-plus-circle me-1"></i> Tambah Pilihan
                    </button>
                </div>

                <div class="mt-2">
                    <label class="fw-bold small text-success">Kunci Jawaban</label>
                    <input type="text" name="kunci_jawaban[]" class="form-control form-control-sm input-kunci-essay" placeholder="Jawaban benar...">
                    <select name="kunci_pg[]" class="form-select form-select-sm input-kunci-pg d-none">
                        <option value="">-- Pilih Jawaban Benar --</option>
                    </select>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    // 4. Fungsi Tambah Opsi (A, B, C...)
    function tambahOpsi(uniqueId) {
        const card = document.getElementById(`soal-${uniqueId}`);
        const container = card.querySelector('.list-opsi-container');
        const index = container.children.length;
        const huruf = String.fromCharCode(65 + index); // 65 = A

        const htmlOpsi = `
            <div class="input-group input-group-sm mb-1 opsi-item">
                <span class="input-group-text fw-bold bg-white text-primary">${huruf}</span>
                <input type="text" name="opsi_${uniqueId}[]" class="form-control" placeholder="Pilihan ${huruf}" required oninput="updateDropdown(this)">
                <button type="button" class="btn btn-outline-danger" onclick="hapusOpsi(this, '${uniqueId}')"><i class="fas fa-times"></i></button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', htmlOpsi);
        refreshDropdownKunci(card);
    }

    // 5. Fungsi Hapus Opsi
    function hapusOpsi(btn, uniqueId) {
        const card = document.getElementById(`soal-${uniqueId}`);
        btn.closest('.opsi-item').remove();
        reindexOpsi(card);
        refreshDropdownKunci(card);
    }

    // 6. Re-Index Huruf
    function reindexOpsi(card) {
        const items = card.querySelectorAll('.opsi-item');
        items.forEach((item, index) => {
            const huruf = String.fromCharCode(65 + index);
            item.querySelector('.input-group-text').innerText = huruf;
            item.querySelector('input').placeholder = `Pilihan ${huruf}`;
        });
    }

    // 7. Update Dropdown Kunci
    function refreshDropdownKunci(card) {
        const dropdown = card.querySelector('.input-kunci-pg');
        const items = card.querySelectorAll('.opsi-item');
        const currentValue = dropdown.value;

        dropdown.innerHTML = '<option value="">-- Pilih Jawaban Benar --</option>';

        items.forEach((item, index) => {
            const huruf = String.fromCharCode(65 + index);
            const option = document.createElement('option');
            option.value = huruf;
            option.text = `(${huruf}) ` + item.querySelector('input').value.substring(0, 20);
            dropdown.add(option);
        });

        dropdown.value = currentValue;
    }

    function updateDropdown(input) {
        const card = input.closest('.soal-item');
        refreshDropdownKunci(card);
    }

    // 8. Toggle Tampilan Essay/PG
    function toggleOpsi(selectElement) {
        const card = selectElement.closest('.soal-item');
        const areaOpsi = card.querySelector('.area-opsi');
        const inputEssay = card.querySelector('.input-kunci-essay');
        const inputPg = card.querySelector('.input-kunci-pg');

        if (selectElement.value === 'pg') {
            areaOpsi.classList.remove('d-none');
            inputEssay.classList.add('d-none');
            inputPg.classList.remove('d-none');
        } else {
            areaOpsi.classList.add('d-none');
            inputEssay.classList.remove('d-none');
            inputPg.classList.add('d-none');
        }
    }
</script>

<%- include('../../partials/footer') %>